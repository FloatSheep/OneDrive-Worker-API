<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>OneDrive CDN ä¸Šä¼ ç¤ºä¾‹</title>
    <style>
      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      body {
        background: linear-gradient(135deg, #1a2a6c, #b21f1f, #1a2a6c);
        color: #fff;
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 30px;
      }

      header {
        text-align: center;
        margin-bottom: 40px;
        padding: 20px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 15px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      }

      h1 {
        font-size: 2.8rem;
        margin-bottom: 10px;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.5);
      }

      .subtitle {
        font-size: 1.2rem;
        opacity: 0.9;
        max-width: 700px;
        margin: 0 auto;
      }

      .card-container {
        display: flex;
        flex-wrap: wrap;
        gap: 30px;
        margin-bottom: 40px;
      }

      .card {
        flex: 1;
        min-width: 300px;
        background: rgba(0, 0, 0, 0.4);
        border-radius: 15px;
        padding: 30px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .card h2 {
        font-size: 1.8rem;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .card h2 i {
        font-size: 1.5rem;
      }

      .form-group {
        margin-bottom: 20px;
      }

      label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
      }

      input,
      select {
        width: 100%;
        padding: 14px;
        border-radius: 8px;
        border: none;
        background: rgba(255, 255, 255, 0.1);
        color: white;
        font-size: 1rem;
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      input::placeholder {
        color: rgba(255, 255, 255, 0.6);
      }

      .file-input-container {
        position: relative;
        margin-bottom: 20px;
      }

      .file-input {
        padding: 40px 20px;
        text-align: center;
        border: 2px dashed rgba(255, 255, 255, 0.3);
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .file-input:hover {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.5);
      }

      .file-input.drag-over {
        background: rgba(92, 184, 92, 0.2);
        border-color: #5cb85c;
      }

      #fileInput,
      #chunkFileInput {
        position: absolute;
        width: 100%;
        height: 100%;
        top: 0;
        left: 0;
        opacity: 0;
        cursor: pointer;
      }

      button {
        width: 100%;
        padding: 16px;
        background: linear-gradient(45deg, #4a90e2, #5e72eb);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        margin-top: 10px;
      }

      button:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
      }

      button:disabled {
        background: linear-gradient(45deg, #555, #777);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .progress-container {
        margin-top: 25px;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 10px;
        padding: 20px;
      }

      .progress-bar {
        height: 25px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        overflow: hidden;
        margin-top: 10px;
        position: relative;
      }

      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #4a90e2, #5e72eb);
        border-radius: 12px;
        width: 0%;
        transition: width 0.3s ease;
      }

      .progress-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-weight: 600;
        text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5);
      }

      .result {
        margin-top: 25px;
        padding: 20px;
        background: rgba(0, 0, 0, 0.3);
        border-radius: 10px;
        min-height: 100px;
        font-family: monospace;
        white-space: pre-wrap;
        word-break: break-all;
        max-height: 300px;
        overflow-y: auto;
      }

      .status {
        padding: 10px;
        border-radius: 8px;
        margin-top: 15px;
        text-align: center;
        font-weight: 500;
      }

      .status.success {
        background: rgba(92, 184, 92, 0.3);
        border: 1px solid #5cb85c;
      }

      .status.error {
        background: rgba(217, 83, 79, 0.3);
        border: 1px solid #d9534f;
      }

      .url-box {
        background: rgba(255, 255, 255, 0.1);
        padding: 12px;
        border-radius: 8px;
        margin: 10px 0;
        word-break: break-all;
      }

      .url-box a {
        color: #4a90e2;
        text-decoration: none;
      }

      .url-box a:hover {
        text-decoration: underline;
      }

      .info-section {
        background: rgba(0, 0, 0, 0.4);
        border-radius: 15px;
        padding: 25px;
        margin-top: 30px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      }

      .info-section h3 {
        font-size: 1.5rem;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .info-content {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
      }

      .info-box {
        background: rgba(255, 255, 255, 0.1);
        padding: 20px;
        border-radius: 10px;
      }

      .info-box h4 {
        margin-bottom: 12px;
        color: #4a90e2;
      }

      .endpoint {
        background: rgba(0, 0, 0, 0.3);
        padding: 10px;
        border-radius: 5px;
        font-family: monospace;
        margin: 8px 0;
        word-break: break-all;
      }

      footer {
        text-align: center;
        margin-top: 40px;
        padding: 20px;
        opacity: 0.7;
        font-size: 0.9rem;
      }

      @media (max-width: 768px) {
        .card-container {
          flex-direction: column;
        }

        h1 {
          font-size: 2.2rem;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <h1>OneDrive CDN Worker ä¸Šä¼ ç¤ºä¾‹</h1>
        <p class="subtitle">
          æ­¤æ¼”ç¤ºé¡µé¢å±•ç¤ºäº†å¦‚ä½•é€šè¿‡ JavaScript
          ä½¿ç”¨æ™®é€šä¸Šä¼ å’Œåˆ†å—ä¸Šä¼ ä¸¤ç§æ–¹å¼å°†æ–‡ä»¶ä¸Šä¼ åˆ° OneDrive CDN Worker æœåŠ¡
        </p>
      </header>

      <div class="card-container">
        <div class="card">
          <h2><i>ğŸ“¤</i> æ™®é€šä¸Šä¼ </h2>
          <p>é€‚åˆå°äº 100MB çš„æ–‡ä»¶</p>

          <div class="form-group">
            <label for="endpoint">ä¸Šä¼ ç«¯ç‚¹ï¼š</label>
            <input
              type="text"
              id="endpoint"
              placeholder="https://your-worker.domain/application-retain/api/upload"
              value=""
            />
          </div>

          <div class="form-group">
            <label for="uploadToken">ä¸Šä¼ ä»¤ç‰Œ (upload_token)ï¼š</label>
            <input type="text" id="uploadToken" placeholder="è¾“å…¥å®‰å…¨ä»¤ç‰Œ" />
          </div>

          <div class="form-group">
            <label for="uploadPath">ä¸Šä¼ è·¯å¾„ï¼š</label>
            <input
              type="text"
              id="uploadPath"
              placeholder="/uploads"
              value="/uploads"
            />
          </div>

          <div class="file-input-container">
            <div class="file-input" id="fileDropArea">
              <p>ç‚¹å‡»æˆ–æ‹–æ”¾æ–‡ä»¶åˆ°æ­¤å¤„</p>
              <p><small>(æœ€å¤§ 100MB)</small></p>
            </div>
            <input type="file" id="fileInput" />
          </div>

          <div class="form-group">
            <label>
              <input type="checkbox" id="realLinkCheckbox" />
              åŒ…å«çœŸå®åœ°å€ (realLink)
            </label>
          </div>

          <button id="uploadBtn" disabled>å¼€å§‹ä¸Šä¼ </button>

          <div class="progress-container">
            <p>ä¸Šä¼ è¿›åº¦ï¼š</p>
            <div class="progress-bar">
              <div class="progress-fill" id="uploadProgress"></div>
              <div class="progress-text" id="uploadProgressText">0%</div>
            </div>
          </div>

          <div class="result" id="uploadResult">
            {/* ä¸Šä¼ ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ */}
          </div>

          <div class="status" id="uploadStatus"></div>
        </div>

        <div class="card">
          <h2><i>ğŸ”—</i> åˆ†å—ä¸Šä¼ </h2>
          <p>é€‚åˆå¤§äº 100MB çš„æ–‡ä»¶ï¼ˆæœ€é«˜ 4GBï¼‰</p>

          <div class="form-group">
            <label for="chunkEndpoint">åˆ›å»ºä¼šè¯ç«¯ç‚¹ï¼š</label>
            <input
              type="text"
              id="chunkEndpoint"
              placeholder="https://your-worker.domain/application-retain/api/upload/create-session"
              value=""
            />
          </div>

          <div class="form-group">
            <label for="chunkToken">ä¸Šä¼ ä»¤ç‰Œ (upload_token)ï¼š</label>
            <input type="text" id="chunkToken" placeholder="è¾“å…¥å®‰å…¨ä»¤ç‰Œ" />
          </div>

          <div class="form-group">
            <label for="chunkPath">ä¸Šä¼ è·¯å¾„ï¼š</label>
            <input
              type="text"
              id="chunkPath"
              placeholder="/large-files"
              value="/large-files"
            />
          </div>

          <div class="form-group">
            <label for="chunkSize">åˆ†å—å¤§å° (MB)ï¼š</label>
            <select id="chunkSize">
              <option value="5">5 MB</option>
              <option value="10" selected>10 MB</option>
              <option value="20">20 MB</option>
              <option value="50">50 MB</option>
            </select>
          </div>

          <div class="file-input-container">
            <div class="file-input" id="chunkFileDropArea">
              <p>ç‚¹å‡»æˆ–æ‹–æ”¾æ–‡ä»¶åˆ°æ­¤å¤„</p>
              <p><small>(æ”¯æŒå¤§æ–‡ä»¶)</small></p>
            </div>
            <input type="file" id="chunkFileInput" />
          </div>

          <div class="form-group">
            <label>
              <input type="checkbox" id="chunkRealLinkCheckbox" />
              åŒ…å«çœŸå®åœ°å€ (realLink)
            </label>
          </div>

          <button id="chunkUploadBtn" disabled>å¼€å§‹åˆ†å—ä¸Šä¼ </button>

          <div class="progress-container">
            <p>ä¸Šä¼ è¿›åº¦ï¼š</p>
            <div class="progress-bar">
              <div class="progress-fill" id="chunkUploadProgress"></div>
              <div class="progress-text" id="chunkUploadProgressText">0%</div>
            </div>
          </div>

          <div class="result" id="chunkUploadResult">
            {/* åˆ†å—ä¸Šä¼ ç»“æœå°†æ˜¾ç¤ºåœ¨è¿™é‡Œ */}
          </div>

          <div class="status" id="chunkUploadStatus"></div>
        </div>
      </div>

      <div class="info-section">
        <h3><i>â„¹ï¸</i> ä½¿ç”¨è¯´æ˜</h3>
        <div class="info-content">
          <div class="info-box">
            <h4>æ™®é€šä¸Šä¼ æµç¨‹</h4>
            <ol>
              <li>è®¾ç½®ä¸Šä¼ ç«¯ç‚¹å’Œå®‰å…¨ä»¤ç‰Œ</li>
              <li>é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶ï¼ˆâ‰¤100MBï¼‰</li>
              <li>ç‚¹å‡»"å¼€å§‹ä¸Šä¼ "æŒ‰é’®</li>
              <li>ç­‰å¾…ä¸Šä¼ å®Œæˆï¼ŒæŸ¥çœ‹ç»“æœ</li>
            </ol>

            <h4>ç«¯ç‚¹ç¤ºä¾‹ï¼š</h4>
            <div class="endpoint">
              POST /application-retain/api/upload?upload_token=YOUR_TOKEN
            </div>
          </div>

          <div class="info-box">
            <h4>åˆ†å—ä¸Šä¼ æµç¨‹</h4>
            <ol>
              <li>è®¾ç½®åˆ›å»ºä¼šè¯ç«¯ç‚¹å’Œå®‰å…¨ä»¤ç‰Œ</li>
              <li>é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶ï¼ˆæ”¯æŒå¤§æ–‡ä»¶ï¼‰</li>
              <li>é€‰æ‹©åˆ†å—å¤§å°ï¼ˆé»˜è®¤10MBï¼‰</li>
              <li>ç‚¹å‡»"å¼€å§‹åˆ†å—ä¸Šä¼ "æŒ‰é’®</li>
              <li>ç­‰å¾…æ‰€æœ‰åˆ†å—ä¸Šä¼ å®Œæˆ</li>
            </ol>

            <h4>ç«¯ç‚¹ç¤ºä¾‹ï¼š</h4>
            <div class="endpoint">
              POST
              /application-retain/api/upload/create-session?upload_token=YOUR_TOKEN
            </div>
            <div class="endpoint">
              PUT /application-retain/api/upload/chunk/:sessionId
            </div>
          </div>

          <div class="info-box">
            <h4>è¿”å›åœ°å€è¯´æ˜</h4>
            <ul>
              <li><strong>CDNåœ°å€</strong>: é€šè¿‡Workerä»£ç†çš„æ–‡ä»¶è®¿é—®åœ°å€</li>
              <li><strong>ä»£ç†æ¨¡å¼</strong>: é€šè¿‡Workerä¸­è½¬æ–‡ä»¶å†…å®¹</li>
              <li>
                <strong>çœŸå®åœ°å€</strong>: åŸå§‹OneDriveåœ°å€ï¼ˆéœ€è¦realLinkå‚æ•°ï¼‰
              </li>
              <li>é»˜è®¤è¿”å›CDNåœ°å€ï¼Œä¿æŠ¤åŸå§‹åœ°å€</li>
            </ul>

            <h4>åˆ†å—å¤§å°å»ºè®®</h4>
            <ul>
              <li>å°æ–‡ä»¶ï¼š5-10 MB</li>
              <li>ä¸­ç­‰æ–‡ä»¶ï¼š10-20 MB</li>
              <li>å¤§æ–‡ä»¶ï¼š20-50 MB</li>
            </ul>
          </div>
        </div>
      </div>

      <footer>
        <p>OneDrive CDN Worker ä¸Šä¼ ç¤ºä¾‹ &copy; 2023 | ä½¿ç”¨çº¯JavaScriptå®ç°</p>
      </footer>
    </div>

    <script>
      // DOMå…ƒç´ å¼•ç”¨
      const fileInput = document.getElementById("fileInput");
      const uploadBtn = document.getElementById("uploadBtn");
      const uploadProgress = document.getElementById("uploadProgress");
      const uploadProgressText = document.getElementById("uploadProgressText");
      const uploadResult = document.getElementById("uploadResult");
      const uploadStatus = document.getElementById("uploadStatus");
      const fileDropArea = document.getElementById("fileDropArea");
      const realLinkCheckbox = document.getElementById("realLinkCheckbox");

      const chunkFileInput = document.getElementById("chunkFileInput");
      const chunkUploadBtn = document.getElementById("chunkUploadBtn");
      const chunkUploadProgress = document.getElementById(
        "chunkUploadProgress"
      );
      const chunkUploadProgressText = document.getElementById(
        "chunkUploadProgressText"
      );
      const chunkUploadResult = document.getElementById("chunkUploadResult");
      const chunkUploadStatus = document.getElementById("chunkUploadStatus");
      const chunkFileDropArea = document.getElementById("chunkFileDropArea");
      const chunkRealLinkCheckbox = document.getElementById(
        "chunkRealLinkCheckbox"
      );
      const baseUrl = "https://purple-bar-9d0e.floatsheep.workers.dev";

      // å½“å‰é€‰ä¸­çš„æ–‡ä»¶
      let selectedFile = null;
      let selectedChunkFile = null;

      // åˆå§‹åŒ–
      document.addEventListener("DOMContentLoaded", () => {
        // è®¾ç½®é»˜è®¤ç«¯ç‚¹ï¼ˆæ ¹æ®å½“å‰åŸŸåï¼‰
        document.getElementById(
          "endpoint"
        ).value = `${baseUrl}/application-retain/api/upload`;
        document.getElementById(
          "chunkEndpoint"
        ).value = `${baseUrl}/application-retain/api/upload/create-session`;

        // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
        setupEventListeners();
      });

      // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
      function setupEventListeners() {
        // æ™®é€šä¸Šä¼ åŒºåŸŸ
        fileInput.addEventListener("change", handleFileSelect);
        uploadBtn.addEventListener("click", startUpload);
        setupDragAndDrop(fileDropArea, fileInput, (file) => {
          selectedFile = file;
          uploadBtn.disabled = false;
          fileDropArea.innerHTML = `<p>å·²é€‰æ‹©: ${
            file.name
          }</p><p><small>å¤§å°: ${formatFileSize(file.size)}</small></p>`;
        });

        // åˆ†å—ä¸Šä¼ åŒºåŸŸ
        chunkFileInput.addEventListener("change", handleChunkFileSelect);
        chunkUploadBtn.addEventListener("click", startChunkUpload);
        setupDragAndDrop(chunkFileDropArea, chunkFileInput, (file) => {
          selectedChunkFile = file;
          chunkUploadBtn.disabled = false;
          chunkFileDropArea.innerHTML = `<p>å·²é€‰æ‹©: ${
            file.name
          }</p><p><small>å¤§å°: ${formatFileSize(file.size)}</small></p>`;
        });
      }

      // è®¾ç½®æ‹–æ”¾åŠŸèƒ½
      function setupDragAndDrop(dropArea, inputElement, callback) {
        // é˜²æ­¢é»˜è®¤æ‹–æ”¾è¡Œä¸º
        ["dragenter", "dragover", "dragleave", "drop"].forEach((eventName) => {
          dropArea.addEventListener(eventName, preventDefaults, false);
          document.body.addEventListener(eventName, preventDefaults, false);
        });

        // é«˜äº®æ‹–æ”¾åŒºåŸŸ
        ["dragenter", "dragover"].forEach((eventName) => {
          dropArea.addEventListener(eventName, highlight, false);
        });

        ["dragleave", "drop"].forEach((eventName) => {
          dropArea.addEventListener(eventName, unhighlight, false);
        });

        // å¤„ç†æ–‡ä»¶æ”¾ç½®
        dropArea.addEventListener("drop", handleDrop, false);

        function preventDefaults(e) {
          e.preventDefault();
          e.stopPropagation();
        }

        function highlight() {
          dropArea.classList.add("drag-over");
        }

        function unhighlight() {
          dropArea.classList.remove("drag-over");
        }

        function handleDrop(e) {
          const dt = e.dataTransfer;
          const files = dt.files;

          if (files.length) {
            inputElement.files = files;
            if (inputElement === fileInput) {
              handleFileSelect();
            } else {
              handleChunkFileSelect();
            }
          }
        }
      }

      // å¤„ç†æ–‡ä»¶é€‰æ‹©ï¼ˆæ™®é€šä¸Šä¼ ï¼‰
      function handleFileSelect() {
        if (fileInput.files.length > 0) {
          selectedFile = fileInput.files[0];
          uploadBtn.disabled = false;
          fileDropArea.innerHTML = `<p>å·²é€‰æ‹©: ${
            selectedFile.name
          }</p><p><small>å¤§å°: ${formatFileSize(
            selectedFile.size
          )}</small></p>`;
        }
      }

      // å¤„ç†æ–‡ä»¶é€‰æ‹©ï¼ˆåˆ†å—ä¸Šä¼ ï¼‰
      function handleChunkFileSelect() {
        if (chunkFileInput.files.length > 0) {
          selectedChunkFile = chunkFileInput.files[0];
          chunkUploadBtn.disabled = false;
          chunkFileDropArea.innerHTML = `<p>å·²é€‰æ‹©: ${
            selectedChunkFile.name
          }</p><p><small>å¤§å°: ${formatFileSize(
            selectedChunkFile.size
          )}</small></p>`;
        }
      }

      // å¼€å§‹æ™®é€šä¸Šä¼ 
      async function startUpload() {
        if (!selectedFile) {
          showStatus(uploadStatus, "è¯·å…ˆé€‰æ‹©æ–‡ä»¶", "error");
          return;
        }

        const endpoint = document.getElementById("endpoint").value;
        const token = document.getElementById("uploadToken").value;
        const path = document.getElementById("uploadPath").value;
        const includeRealLink = realLinkCheckbox.checked;

        if (!token) {
          showStatus(uploadStatus, "è¯·è¾“å…¥ä¸Šä¼ ä»¤ç‰Œ", "error");
          return;
        }

        // ç¦ç”¨æŒ‰é’®
        uploadBtn.disabled = true;
        uploadBtn.textContent = "ä¸Šä¼ ä¸­...";

        // é‡ç½®çŠ¶æ€
        uploadProgress.style.width = "0%";
        uploadProgressText.textContent = "0%";
        uploadResult.textContent = "";
        showStatus(uploadStatus, "å¼€å§‹ä¸Šä¼ ...");

        try {
          // åˆ›å»ºFormData
          const formData = new FormData();
          formData.append("file", selectedFile);
          formData.append("path", path);

          // åˆ›å»ºè¯·æ±‚URL
          const url = new URL(endpoint);
          url.searchParams.append("upload_token", token);

          // æ·»åŠ realLinkå‚æ•°
          if (includeRealLink) {
            url.searchParams.append("realLink", "true");
          }

          // å‘é€è¯·æ±‚
          const response = await fetch(url, {
            method: "POST",
            body: formData,
          });

          // å¤„ç†å“åº”
          if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || "ä¸Šä¼ å¤±è´¥");
          }

          const result = await response.json();

          if (result.code === 200) {
            // æ˜¾ç¤ºCDN URL
            const cdnUrl = result.data.cdn_url;
            const cdnProxyUrl = result.data.cdn_proxy_url;

            uploadResult.innerHTML = `
                        <h3>ä¸Šä¼ æˆåŠŸï¼</h3>
                        <div class="url-box">
                            <strong>CDNåœ°å€:</strong>
                            <a href="${cdnUrl}" target="_blank">${cdnUrl}</a>
                        </div>
                        <div class="url-box">
                            <strong>ä»£ç†æ¨¡å¼:</strong>
                            <a href="${cdnProxyUrl}" target="_blank">${cdnProxyUrl}</a>
                        </div>
                    `;

            // å¦‚æœåŒ…å«çœŸå®åœ°å€
            if (result.data.real_web_url) {
              uploadResult.innerHTML += `
                            <div class="url-box">
                                <strong>çœŸå®ä¸‹è½½åœ°å€:</strong>
                                <a href="${
                                  result.data.real_web_url
                                }" target="_blank" style="word-break:break-all;">
                                    ${result.data.real_web_url.substring(
                                      0,
                                      60
                                    )}...
                                </a>
                            </div>
                        `;
            }

            showStatus(uploadStatus, "ä¸Šä¼ æˆåŠŸï¼", "success");
          } else {
            uploadResult.textContent = JSON.stringify(result, null, 2);
            showStatus(uploadStatus, `ä¸Šä¼ å¤±è´¥: ${result.message}`, "error");
          }
        } catch (error) {
          uploadResult.textContent = `é”™è¯¯: ${error.message}`;
          showStatus(uploadStatus, `ä¸Šä¼ å¤±è´¥: ${error.message}`, "error");
        } finally {
          uploadBtn.disabled = false;
          uploadBtn.textContent = "å¼€å§‹ä¸Šä¼ ";
        }
      }

      // å¼€å§‹åˆ†å—ä¸Šä¼ 
      async function startChunkUpload() {
        if (!selectedChunkFile) {
          showStatus(chunkUploadStatus, "è¯·å…ˆé€‰æ‹©æ–‡ä»¶", "error");
          return;
        }

        const endpoint = document.getElementById("chunkEndpoint").value;
        const token = document.getElementById("chunkToken").value;
        const path = document.getElementById("chunkPath").value;
        const chunkSize =
          parseInt(document.getElementById("chunkSize").value) * 1024 * 1024;
        const includeRealLink = chunkRealLinkCheckbox.checked;

        if (!token) {
          showStatus(chunkUploadStatus, "è¯·è¾“å…¥ä¸Šä¼ ä»¤ç‰Œ", "error");
          return;
        }

        // ç¦ç”¨æŒ‰é’®
        chunkUploadBtn.disabled = true;
        chunkUploadBtn.textContent = "ä¸Šä¼ ä¸­...";

        // é‡ç½®çŠ¶æ€
        chunkUploadProgress.style.width = "0%";
        chunkUploadProgressText.textContent = "0%";
        chunkUploadResult.textContent = "";
        showStatus(chunkUploadStatus, "å¼€å§‹åˆ†å—ä¸Šä¼ ...");

        try {
          // 1. åˆ›å»ºä¸Šä¼ ä¼šè¯
          const sessionResult = await createUploadSession(
            endpoint,
            token,
            path,
            selectedChunkFile.name,
            includeRealLink
          );

          if (!sessionResult.data) {
            throw new Error("æ— æ³•åˆ›å»ºä¸Šä¼ ä¼šè¯");
          }

          const sessionId = sessionResult.data.session_id;
          const fileSize = selectedChunkFile.size;
          const totalChunks = Math.ceil(fileSize / chunkSize);

          showStatus(
            chunkUploadStatus,
            `åˆ›å»ºä¼šè¯æˆåŠŸï¼Œå¼€å§‹ä¸Šä¼  ${totalChunks} ä¸ªåˆ†å—...`
          );

          // 2. ä¸Šä¼ æ‰€æœ‰åˆ†å—
          let uploadedBytes = 0;

          let chunkResponse
          for (let chunkIndex = 0; chunkIndex < totalChunks; chunkIndex++) {
            const start = chunkIndex * chunkSize;
            const end = Math.min(start + chunkSize, fileSize);
            const chunk = selectedChunkFile.slice(start, end);

            // æ›´æ–°è¿›åº¦
            const progress = Math.round((chunkIndex / totalChunks) * 100);
            chunkUploadProgress.style.width = `${progress}%`;
            chunkUploadProgressText.textContent = `${progress}%`;

            // ä¸Šä¼ åˆ†å—
            showStatus(
              chunkUploadStatus,
              `ä¸Šä¼ åˆ†å— ${chunkIndex + 1}/${totalChunks}...`
            );
            chunkResponse = await uploadChunk(
              sessionId,
              chunk,
              start,
              end - 1,
              fileSize
            );

            uploadedBytes = end;

            // å¤„ç†ä¸­é—´å“åº”
            if (chunkResponse.code === 202) {
              showStatus(
                chunkUploadStatus,
                `åˆ†å— ${
                  chunkIndex + 1
                }/${totalChunks} ä¸Šä¼ æˆåŠŸï¼Œç»§ç»­ä¸‹ä¸€ä¸ªåˆ†å—...`
              );
            }

            // æ›´æ–°è¿›åº¦
            const newProgress = Math.round((uploadedBytes / fileSize) * 100);
            chunkUploadProgress.style.width = `${newProgress}%`;
            chunkUploadProgressText.textContent = `${newProgress}%`;
          }

          // 3. å®Œæˆä¸Šä¼ 
          chunkUploadProgress.style.width = "100%";
          chunkUploadProgressText.textContent = "100%";
          showStatus(chunkUploadStatus, "æ‰€æœ‰åˆ†å—ä¸Šä¼ å®Œæˆï¼", "success");

          // æ˜¾ç¤ºæœ€ç»ˆç»“æœ
          const cdnUrl = chunkResponse.data.cdn_url;
          const cdnProxyUrl = `${cdnUrl}?proxy`;

          chunkUploadResult.innerHTML = `
                    <h3>ä¸Šä¼ æˆåŠŸï¼</h3>
                    <div class="url-box">
                        <strong>CDNåœ°å€:</strong>
                        <a href="${cdnUrl}" target="_blank">${cdnUrl}</a>
                    </div>
                    <div class="url-box">
                        <strong>ä»£ç†æ¨¡å¼:</strong>
                        <a href="${cdnProxyUrl}" target="_blank">${cdnProxyUrl}</a>
                    </div>
                `;

          // å¦‚æœåŒ…å«çœŸå®åœ°å€
          if (chunkResponse.data.real_web_url) {
            chunkUploadResult.innerHTML += `
                        <div class="url-box">
                            <strong>çœŸå®ä¸‹è½½åœ°å€:</strong>
                            <a href="${
                              chunkResponse.data.real_web_url
                            }" target="_blank" style="word-break:break-all;">
                                ${chunkResponse.data.real_web_url.substring(
                                  0,
                                  60
                                )}...
                            </a>
                        </div>
                    `;
          }
        } catch (error) {
          chunkUploadResult.textContent = `é”™è¯¯: ${error.message}`;
          showStatus(
            chunkUploadStatus,
            `åˆ†å—ä¸Šä¼ å¤±è´¥: ${error.message}`,
            "error"
          );
        } finally {
          chunkUploadBtn.disabled = false;
          chunkUploadBtn.textContent = "å¼€å§‹åˆ†å—ä¸Šä¼ ";
        }
      }

      // åˆ›å»ºä¸Šä¼ ä¼šè¯
      async function createUploadSession(
        endpoint,
        token,
        path,
        fileName,
        includeRealLink
      ) {
        const url = new URL(endpoint);
        url.searchParams.append("upload_token", token);

        // æ·»åŠ realLinkå‚æ•°
        if (includeRealLink) {
          url.searchParams.append("realLink", "true");
        }

        const response = await fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            fileName: fileName,
            fileSize: selectedChunkFile.size,
            uploadPath: path,
          }),
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.message || "åˆ›å»ºä¼šè¯å¤±è´¥");
        }

        return await response.json();
      }

      // ä¸Šä¼ åˆ†å—
      async function uploadChunk(sessionId, chunk, start, end, totalSize) {
        // æ„å»ºåˆ†å—ä¸Šä¼ URL
        const chunkUrl = new URL(baseUrl);
        chunkUrl.pathname = `/application-retain/api/upload/chunk/${sessionId}`;

        // è®¾ç½®Content-Rangeå¤´
        const contentRange = `bytes ${start}-${end}/${totalSize}`;

        const response = await fetch(chunkUrl, {
          method: "PUT",
          headers: {
            "Content-Range": contentRange,
            "Content-Type": "application/octet-stream",
          },
          body: chunk,
        });

        if (!response.ok) {
          const error = await response.text();
          throw new Error(`åˆ†å—ä¸Šä¼ å¤±è´¥: ${error}`);
        }

        return await response.json();
      }

      // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
      function showStatus(element, message, type) {
        element.textContent = message;
        element.className = "status";

        if (type === "success") {
          element.classList.add("success");
        } else if (type === "error") {
          element.classList.add("error");
        }
      }

      // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
      function formatFileSize(bytes) {
        if (bytes === 0) return "0 Bytes";

        const k = 1024;
        const sizes = ["Bytes", "KB", "MB", "GB"];
        const i = Math.floor(Math.log(bytes) / Math.log(k));

        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + " " + sizes[i];
      }
    </script>
  </body>
</html>
